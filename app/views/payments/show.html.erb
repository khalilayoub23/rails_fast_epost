<% content_for :page_title, "Payment ##{@payment.id}" %>

<div class="space-y-6">
	<div class="flex items-center justify-between">
		<div>
			<nav class="flex text-sm text-gray-500" aria-label="Breadcrumb">
				<ol class="inline-flex items-center space-x-1 md:space-x-3">
					<li class="inline-flex items-center">
						<%= link_to root_path, class: "text-gray-500 hover:text-gray-700" do %>
							<span class="material-icons text-sm mr-1">home</span>
							Home
						<% end %>
					</li>
					<li>
						<div class="flex items-center">
							<span class="material-icons text-sm text-gray-400 mx-1">chevron_right</span>
							<%= link_to "Payments", payments_path, class: "text-gray-500 hover:text-gray-700" %>
						</div>
					</li>
					<li>
						<div class="flex items-center">
							<span class="material-icons text-sm text-gray-400 mx-1">chevron_right</span>
							<span class="text-gray-700 font-medium">#<%= @payment.id %></span>
						</div>
					</li>
				</ol>
			</nav>
		</div>
	</div>

	<div class="bg-white rounded-lg border border-gray-200 shadow-sm">
		<div class="px-6 py-4 border-b border-gray-200">
			<h2 class="text-lg font-semibold text-gray-900">Payment #<%= @payment.id %></h2>
		</div>
		<div class="p-6 space-y-1">
			<div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
				<div>
					<div class="text-sm font-medium text-gray-600">Category</div>
					<div class="text-gray-900 capitalize"><%= @payment.category %></div>
				</div>
				<div>
					<div class="text-sm font-medium text-gray-600">Provider</div>
					<div class="text-gray-900 capitalize"><%= @payment.provider %></div>
				</div>
				<div>
					<div class="text-sm font-medium text-gray-600">Status</div>
					<div><%= render "shared/status_badge", status: @payment.gateway_status %></div>
				</div>
				<div>
					<div class="text-sm font-medium text-gray-600">Amount</div>
					<div class="text-gray-900"><%= @payment.amount_cents ? ("%.2f" % (@payment.amount_cents / 100.0)) : "-" %> <%= @payment.currency %></div>
				</div>
				<div class="sm:col-span-2">
					<div class="text-sm font-medium text-gray-600">Total Refunded (computed)</div>
					<div class="text-gray-900"><%= number_to_currency(@payment.refunds.sum(:amount_cents).to_i / 100.0, unit: @payment.currency) %></div>
				</div>
			</div>
		</div>
	</div>

<% if @payment.provider == "stripe" %>
	<div class="bg-white rounded-lg border border-gray-200 shadow-sm">
		<div class="px-6 py-4 border-b border-gray-200">
			<h3 class="text-lg font-semibold text-gray-900">Stripe Details</h3>
		</div>
		<div class="p-6">
			<div class="overflow-x-auto">
				<ul class="space-y-3">
					<li class="flex justify-between items-center py-2 border-b border-gray-100">
						<span class="text-sm font-medium text-gray-600">Customer:</span>
						<code class="text-sm text-gray-900 bg-gray-50 px-2 py-1 rounded"><%= @payment.stripe_customer_id || '-' %></code>
					</li>
					<li class="flex justify-between items-center py-2 border-b border-gray-100">
						<span class="text-sm font-medium text-gray-600">Payment Intent:</span>
						<code class="text-sm text-gray-900 bg-gray-50 px-2 py-1 rounded"><%= @payment.payment_intent_id || '-' %></code>
					</li>
					<li class="flex justify-between items-center py-2 border-b border-gray-100">
						<span class="text-sm font-medium text-gray-600">Checkout Session:</span>
						<code class="text-sm text-gray-900 bg-gray-50 px-2 py-1 rounded"><%= @payment.checkout_session_id || '-' %></code>
					</li>
					<li class="flex justify-between items-center py-2 border-b border-gray-100">
						<span class="text-sm font-medium text-gray-600">Charge:</span>
						<code class="text-sm text-gray-900 bg-gray-50 px-2 py-1 rounded"><%= @payment.charge_id || '-' %></code>
					</li>
					<li class="flex justify-between items-center py-2">
						<span class="text-sm font-medium text-gray-600">Total Refunded:</span>
						<code class="text-sm text-gray-900 bg-gray-50 px-2 py-1 rounded"><%=
						  (total = @payment.refunds.sum(:amount_cents)) && total > 0 ? ("%.2f" % (total / 100.0)) : '-'
						%></code>
					</li>
				</ul>
			</div>
		</div>
	</div>

	<div class="bg-white rounded-lg border border-gray-200 shadow-sm">
		<div class="px-6 py-4 border-b border-gray-200">
			<h3 class="text-lg font-semibold text-gray-900">Stripe Actions</h3>
		</div>
		<div class="p-6">
			<div class="flex flex-wrap gap-3">
				<% unless @payment.gateway_status == "refunded" %>
					<button data-modal-target="refundModal" data-modal-toggle="refundModal"
								class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
						<span class="material-icons text-sm mr-2">keyboard_return</span>
						Refund
					</button>
				<% end %>
				<% if @payment.gateway_status == "pending" %>
					<%= button_to capture_payment_path(@payment), method: :post, class: "inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500" do %>
						<span class="material-icons text-sm mr-2">check_circle</span>
						Capture
					<% end %>
					<%= button_to cancel_payment_path(@payment), method: :post, class: "inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" do %>
						<span class="material-icons text-sm mr-2">cancel</span>
						Cancel
					<% end %>
				<% end %>
				<%= button_to sync_payment_path(@payment), method: :post, class: "inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500" do %>
					<span class="material-icons text-sm mr-2">sync</span>
					Sync
				<% end %>
			</div>
		</div>
	</div>
		<!-- Flowbite Refund Modal -->
		<div id="refundModal" tabindex="-1" aria-hidden="true" class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full">
			<div class="relative p-4 w-full max-w-md max-h-full">
				<div class="relative bg-white rounded-lg shadow">
					<div class="flex items-center justify-between p-4 border-b rounded-t">
						<h3 class="text-lg font-semibold">Issue Refund</h3>
						<button type="button" class="text-gray-400 hover:text-gray-900" data-modal-hide="refundModal">âœ•</button>
					</div>
					<div class="p-4">
						<%= form_with url: refund_payment_path(@payment), method: :post do |f| %>
							<div class="space-y-3">
								<div>
									<label class="block text-sm font-medium text-gray-700">Amount (cents)</label>
									<input type="number" name="amount_cents" class="mt-1 w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Optional" />
								</div>
								<div>
									<label class="block text-sm font-medium text-gray-700">Reason</label>
									<input type="text" name="reason" class="mt-1 w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Optional" />
								</div>
								<div class="flex justify-end gap-3 pt-4">
									<button type="button" data-modal-hide="refundModal" class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Cancel</button>
									<button type="submit" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Submit Refund</button>
								</div>
							</div>
						<% end %>
					</div>
				</div>
			</div>
		</div>

	<div class="bg-white rounded-lg border border-gray-200 shadow-sm">
		<div class="px-6 py-4 border-b border-gray-200">
			<h3 class="text-lg font-semibold text-gray-900">Refund History</h3>
		</div>
		<% if @payment.refunds.any? %>
			<div class="overflow-x-auto">
				<table class="min-w-full divide-y divide-gray-200">
					<thead class="bg-gray-50">
						<tr>
							<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
							<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
							<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Currency</th>
							<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
							<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reason</th>
							<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Occurred At</th>
						</tr>
					</thead>
					<tbody class="bg-white divide-y divide-gray-200">
						<% @payment.refunds.order(occurred_at: :desc, created_at: :desc).each do |r| %>
							<tr class="hover:bg-gray-50">
								<td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-gray-900"><%= r.refund_id || r.id %></td>
								<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900"><%= r.amount_cents ? ("%.2f" % (r.amount_cents / 100.0)) : "-" %></td>
								<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"><%= r.currency || '-' %></td>
								<td class="px-6 py-4 whitespace-nowrap"><%= render "shared/status_badge", status: r.status %></td>
								<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"><%= r.reason || '-' %></td>
								<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"><%= r.occurred_at&.strftime("%b %d, %Y") || r.created_at.strftime("%b %d, %Y") %></td>
							</tr>
						<% end %>
					</tbody>
				</table>
			</div>
		<% else %>
			<div class="px-6 py-8 text-center">
				<span class="material-icons text-gray-400 text-4xl mb-2">keyboard_return</span>
				<h3 class="text-sm font-medium text-gray-900 mb-1">No refunds</h3>
				<p class="text-sm text-gray-500">No refunds recorded for this payment yet.</p>
			</div>
		<% end %>
	</div>
	<% end %>
