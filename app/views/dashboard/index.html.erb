<div data-controller="dashboard-editor" data-dashboard-editor-save-url-value="<%= admin_dashboard_layout_path %>">
  <% card_class = "rounded-2xl border border-white/10 bg-white/5 shadow-xl shadow-black/30 backdrop-blur" %>
  <!-- Header moved to topbar -->

  <%= turbo_stream_from "dashboard" %>

  <div class="space-y-6">
    <%= render "header" %>

  <% if %w[admin manager operational].include?(@dashboard_view) %>
    <%= render "filters",
          dashboard_view: @dashboard_view,
          payment_statuses: @payment_statuses,
          payment_filters: @payment_filters,
          task_statuses: @task_statuses,
          task_filters: @task_filters,
          delivery_statuses: @delivery_statuses,
          delivery_filters: @delivery_filters %>
  <% end %>

  <div class="grid grid-cols-12 gap-4 md:gap-6 2xl:gap-7.5"
       data-dashboard-editor-target="container">
    <% layout = JSON.parse(File.read(Rails.root.join('config','dashboard_layout.json'))) rescue [] %>
    <% layout.each do |w| %>
      <% id = w["id"]; span = w["span"] %>
      <% if id == "kpis" %>
        <div data-widget-id="kpis" data-span="<%= span || 'col-span-12' %>" class="<%= span || 'col-span-12' %>">
          <%= render "kpis" %>
        </div>
      <% elsif id == "chart" %>
        <%= render "chart_widget",
              span: span,
              card_class: card_class,
              series_a: @chart_series_a_by_period,
              series_b: @chart_series_b_by_period %>
      <% elsif id == "target" %>
        <%= render "target_widget",
              span: span,
              card_class: card_class,
              target_percent: @target_percent,
              target_delta_percent: @target_delta_percent,
              monthly_target_cents: @monthly_target_cents,
              month_revenue_cents: @month_revenue_cents,
              today_revenue_cents: @today_revenue_cents,
              currency_code: @currency_code %>
      <% elsif id == "recent_payments" %>
        <%= render "recent_payments_widget",
              span: span,
              card_class: card_class,
              recent_payments: @recent_payments %>
      <% elsif id == "recent_tasks" %>
        <%= render "recent_tasks_widget",
              span: span,
              card_class: card_class,
              recent_tasks: @recent_tasks %>
      <% end %>
    <% end %>
  </div>

<% if %w[admin manager operational].include?(@dashboard_view) %>
  <%= render "deliveries_widget", card_class: card_class, delivery_samples: @delivery_samples %>
<% end %>

<% if @dashboard_view == "carrier" %>
  <%= render "payouts_widget", card_class: card_class, recent_payouts: @recent_payouts, currency_code: @currency_code %>
<% end %>
  </div>
</div>
