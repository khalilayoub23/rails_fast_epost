<div data-controller="dashboard-editor" data-dashboard-editor-save-url-value="<%= admin_dashboard_layout_path %>">
  <% card_class = "rounded-2xl border border-white/10 bg-white/5 shadow-xl shadow-black/30 backdrop-blur" %>
  <!-- Header moved to topbar -->

  <%= turbo_stream_from "dashboard" %>

  <% if %w[admin manager operational].include?(@dashboard_view) %>
    <%= form_with url: dashboard_path, method: :get, local: true, class: "mb-6 rounded-2xl border border-white/10 bg-white/5 p-4" do %>
      <div class="flex flex-col gap-3 sm:flex-row sm:items-end">
        <% if %w[admin manager].include?(@dashboard_view) %>
          <div class="flex-1">
            <label class="block text-xs font-semibold text-slate-400 mb-1">Payment status</label>
            <%= select_tag "payment_filter[status]",
                options_for_select([ ["All", ""] ] + (@payment_statuses || Payment.gateway_statuses.keys).map { |s| [s.titleize, s] }, @payment_filters&.[](:status)),
                class: "w-full rounded border border-white/10 bg-white/5 px-3 py-2 text-sm text-white" %>
          </div>
        <% end %>

        <div class="flex-1">
          <label class="block text-xs font-semibold text-slate-400 mb-1">Task status</label>
          <%= select_tag "task_filter[status]",
              options_for_select([ ["All", ""] ] + (@task_statuses || Task.statuses.keys).map { |s| [s.titleize, s] }, @task_filters&.[](:status)),
              class: "w-full rounded border border-white/10 bg-white/5 px-3 py-2 text-sm text-white" %>
        </div>

        <div class="flex-1">
          <label class="block text-xs font-semibold text-slate-400 mb-1">Delivery status</label>
          <%= select_tag "delivery_filter[status]",
              options_for_select([ ["All", ""] ] + (@delivery_statuses || Delivery.statuses.keys).map { |s| [s.titleize, s] }, @delivery_filters&.[](:status)),
              class: "w-full rounded border border-white/10 bg-white/5 px-3 py-2 text-sm text-white" %>
        </div>

        <div>
          <%= submit_tag "Apply", class: "inline-flex items-center justify-center rounded-md bg-primary px-4 py-2 text-sm font-medium text-black hover:bg-opacity-90" %>
        </div>
      </div>
    <% end %>
  <% end %>

<div class="grid grid-cols-12 gap-4 md:gap-6 2xl:gap-7.5"
     data-dashboard-editor-target="container">
  <% layout = JSON.parse(File.read(Rails.root.join('config','dashboard_layout.json'))) rescue [] %>
  <% layout.each do |w| %>
    <% id = w["id"]; span = w["span"] %>
    <% if id == "kpis" %>
      <div data-widget-id="kpis" data-span="<%= span || 'col-span-12' %>" class="<%= span || 'col-span-12' %>">
        <%= render "kpis" %>
      </div>
    <% elsif id == "chart" %>
      <!-- Monthly Sales Chart - Dark Theme -->
      <div data-widget-id="chart"
           data-span="<%= span %>"
           class="<%= span %> <%= card_class %> px-5 pb-5 pt-7.5 sm:px-7.5"
           data-controller="charts"
           data-charts-series-a-value='<%= (@chart_series_a_by_period || {}).to_json %>'
           data-charts-series-b-value='<%= (@chart_series_b_by_period || {}).to_json %>'>
    <div class="flex flex-wrap items-start justify-between gap-3 sm:flex-nowrap">
      <div class="flex w-full flex-wrap gap-3 sm:gap-5">
        <div class="flex min-w-47.5">
          <span class="mr-2 mt-1 flex h-4 w-full max-w-4 items-center justify-center rounded-full border border-yellow-400">
            <span class="block h-2.5 w-full max-w-2.5 rounded-full bg-yellow-400"></span>
          </span>
          <div class="w-full">
            <p class="font-semibold text-yellow-400">Succeeded Payments</p>
          </div>
        </div>
        <div class="flex min-w-47.5">
          <span class="mr-2 mt-1 flex h-4 w-full max-w-4 items-center justify-center rounded-full border border-blue-400">
            <span class="block h-2.5 w-full max-w-2.5 rounded-full bg-blue-400"></span>
          </span>
          <div class="w-full">
            <p class="font-semibold text-blue-400">Tasks Created</p>
          </div>
        </div>
      </div>
      <div class="flex w-full max-w-45 justify-end">
        <div class="inline-flex items-center rounded-lg bg-white/10 p-1.5">
          <button data-action="click->charts#update" data-charts-period-param="day" class="px-3 py-1 text-xs font-medium text-slate-300 hover:bg-white/10 hover:text-white rounded transition-colors">
            Day
          </button>
          <button data-action="click->charts#update" data-charts-period-param="week" class="px-3 py-1 text-xs font-medium text-slate-300 hover:bg-white/10 hover:text-white rounded transition-colors">
            Week
          </button>
          <button data-action="click->charts#update" data-charts-period-param="month" class="rounded bg-yellow-400 px-3 py-1 text-xs font-medium text-black shadow-lg hover:bg-yellow-500 transition-colors">
            Month
          </button>
        </div>
      </div>
    </div>

    <div>
      <div id="chartOne" class="-ml-5" data-charts-target="chartContainer"></div>
    </div>
      </div>
    <% elsif id == "target" %>
      <!-- Monthly Target - Dark Theme -->
      <div data-widget-id="target" data-span="<%= span %>" class="<%= span %> <%= card_class %> p-7.5">
        <% target_percent = (@target_percent || 0).to_i %>
        <% radius = 80 %>
        <% circumference = 2 * Math::PI * radius %>
        <% dashoffset = circumference * (1 - (target_percent / 100.0)) %>
    <div class="mb-4 justify-between gap-4 sm:flex">
      <div>
        <h5 class="text-xl font-semibold text-dark dark:text-white">
          Monthly Target
        </h5>
      </div>
      <div class="relative z-20 inline-block">
        <select name="" id="" class="relative z-20 inline-flex appearance-none rounded-lg border border-stroke bg-transparent py-1 pl-3 pr-8 text-sm font-medium text-black outline-none transition focus:border-primary dark:border-form-strokedark dark:bg-form-input dark:text-white dark:focus:border-primary">
          <option value="">This Month</option>
          <option value="">Last Month</option>
        </select>
        <span class="absolute right-3 top-1/2 z-10 -translate-y-1/2">
          <svg width="10" height="6" viewBox="0 0 10 6" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M0.47072 1.08816C0.47072 1.02932 0.500141 0.955772 0.54404 0.911882C0.551987 0.903934 0.551987 0.903934 0.559934 0.895887L0.667063 0.789758C0.711953 0.744868 0.785499 0.715446 0.844341 0.715446C0.903183 0.715446 0.976729 0.744868 1.02162 0.789758L5.00007 4.56497L8.97852 0.789758C9.02341 0.744868 9.09696 0.715446 9.1558 0.715446C9.21464 0.715446 9.28819 0.744868 9.33308 0.789758L9.44021 0.895887C9.44816 0.903934 9.44816 0.903934 9.45611 0.911882C9.50001 0.955772 9.52943 1.02932 9.52943 1.08816C9.52943 1.147 9.50001 1.22055 9.45611 1.26444L5.2308 5.36379C5.1859 5.40868 5.11235 5.4381 5.05351 5.4381C4.99467 5.4381 4.92112 5.40868 4.87623 5.36379L0.650904 1.26444C0.607014 1.22055 0.57759 1.147 0.57759 1.08816C0.57759 1.08816 0.552669 1.11308 0.47072 1.08816Z" fill="#9CA3AF"/>
          </svg>
        </span>
      </div>
    </div>

    <div class="mb-2">
      <p class="font-medium text-slate-400">Target you've set for each month</p>
    </div>

    <div class="mx-auto flex justify-center relative">
      <svg class="rotate-90 transform" width="200" height="200">
        <circle cx="100" cy="100" r="80" stroke="#374151" stroke-width="16" fill="transparent"/>
        <circle cx="100" cy="100" r="80" stroke="#FBBF24" stroke-width="16" fill="transparent" stroke-dasharray="<%= circumference %>" stroke-dashoffset="<%= dashoffset %>" stroke-linecap="round"/>
      </svg>
      <div class="absolute inset-0 flex flex-col items-center justify-center">
        <span class="text-3xl font-bold text-dark dark:text-white"><%= number_to_percentage(target_percent, precision: 0) %></span>
        <% delta = (@target_delta_percent || 0).to_i %>
        <% delta_class = delta.negative? ? "text-rose-400" : "text-green-400" %>
        <span class="text-sm font-medium <%= delta_class %>"><%= delta.positive? ? "+#{delta}" : delta %>%</span>
      </div>
    </div>

    <div class="mt-7">
      <p class="mb-3 font-medium text-dark dark:text-white">
        You earn <%= format_money_cents(@today_revenue_cents || 0, currency: @currency_code, precision: 0) %> today, it's higher than last month.
      </p>
      <p class="text-sm text-body dark:text-bodydark">Keep up your good work!</p>
    </div>

    <div class="mt-5 flex items-center justify-between border-t border-white/10 pt-5">
      <div>
        <p class="font-medium text-slate-400 text-sm">Target</p>
        <p class="text-xl font-bold text-yellow-400"><%= format_money_cents(@monthly_target_cents || 0, currency: @currency_code, precision: 0) %></p>
      </div>
      <div>
        <p class="font-medium text-slate-400 text-sm">Revenue</p>
        <p class="text-xl font-bold text-green-400"><%= format_money_cents(@month_revenue_cents || 0, currency: @currency_code, precision: 0) %></p>
      </div>
      <div>
        <p class="font-medium text-slate-400 text-sm">Today</p>
        <p class="text-xl font-bold text-green-400"><%= format_money_cents(@today_revenue_cents || 0, currency: @currency_code, precision: 0) %></p>
      </div>
    </div>
      </div>
    <% elsif id == "recent_payments" %>
      <!-- Recent Payments - Dark Theme -->
      <div data-widget-id="recent_payments" data-span="<%= span %>" class="<%= span %> <%= card_class %> px-5 pt-6 pb-2.5 sm:px-7.5">
    <div class="mb-6 flex items-center justify-between">
      <h3 class="text-title-md font-semibold text-white"><%= t("dashboard.recent_payments", default: "Payments") %></h3>
      <%= link_to "View all", payments_path, class: "text-sm font-medium text-yellow-300 hover:text-yellow-200 transition-colors" %>
    </div>
    <div class="max-w-full overflow-x-auto">
      <table class="w-full table-auto">
        <thead>
          <tr class="bg-white/5 text-left border-b border-white/10">
            <th class="px-4 py-4 font-medium text-slate-200">ID</th>
            <th class="px-4 py-4 font-medium text-slate-200">Provider</th>
            <th class="px-4 py-4 font-medium text-slate-200"><%= t("dashboard.status", default: "Status") %></th>
            <th class="px-4 py-4 font-medium text-slate-200">Amount</th>
            <th class="px-4 py-4 font-medium text-slate-200">Currency</th>
            <th class="px-4 py-4 text-right font-medium text-slate-200">Actions</th>
          </tr>
        </thead>
        <tbody>
          <% Array(@recent_payments).each do |payment| %>
            <%= render "payments/payment", payment: payment %>
          <% end %>
        </tbody>
      </table>
    </div>
      </div>
    <% elsif id == "recent_tasks" %>
      <!-- Recent Tasks - Dark Theme -->
      <div data-widget-id="recent_tasks" data-span="<%= span %>" class="<%= span %> <%= card_class %> px-5 pt-6 pb-2.5 sm:px-7.5">
    <div class="mb-6 flex items-center justify-between">
      <h3 class="text-title-md font-semibold text-white"><%= t("dashboard.recent_tasks", default: "Tasks") %></h3>
      <%= link_to "View all", tasks_path, class: "text-sm font-medium text-yellow-300 hover:text-yellow-200 transition-colors" %>
    </div>
    <div class="max-w-full overflow-x-auto">
      <table class="w-full table-auto">
        <thead>
          <tr class="bg-white/5 text-left border-b border-white/10">
            <th class="px-4 py-4 font-medium text-slate-200">Task</th>
            <th class="px-4 py-4 font-medium text-slate-200">Customer</th>
            <th class="px-4 py-4 font-medium text-slate-200">Priority</th>
            <th class="px-4 py-4 font-medium text-slate-200"><%= t("dashboard.status", default: "Status") %></th>
            <th class="px-4 py-4 text-right font-medium text-slate-200">Actions</th>
          </tr>
        </thead>
        <tbody>
          <% Array(@recent_tasks).each do |task| %>
            <tr class="border-b border-white/10 hover:bg-white/5 transition-colors">
              <td class="px-4 py-4 text-sm font-medium text-white">
                <%= link_to task_path(task), class: "text-yellow-300 hover:text-yellow-200 transition-colors" do %>
                  <%= task.title.presence || "Task ##{task.id}" %>
                <% end %>
              </td>
              <td class="px-4 py-4 text-sm text-slate-300"><%= task.customer&.name || "-" %></td>
              <td class="px-4 py-4">
                <%= render "shared/priority_badge", priority: task.priority %>
              </td>
              <td class="px-4 py-4">
                <%= render "shared/status_badge", status: task.status %>
              </td>
              <td class="px-4 py-4 text-right">
                <%= link_to "View", task_path(task), class: "inline-flex items-center rounded-xl border border-white/10 bg-white/5 px-3 py-1 text-sm font-medium text-white hover:bg-white/10" %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
      </div>
    <% end %>
  <% end %>
</div>

<% if %w[admin manager operational].include?(@dashboard_view) %>
  <div class="mt-6 <%= card_class %> px-5 pt-6 pb-2.5 sm:px-7.5">
    <div class="mb-6 flex items-center justify-between">
      <h3 class="text-title-md font-semibold text-white"><%= t("deliveries.index.title", default: "Deliveries") %></h3>
      <%= link_to "View all", deliveries_path, class: "text-sm font-medium text-yellow-300 hover:text-yellow-200 transition-colors" %>
    </div>

    <div class="max-w-full overflow-x-auto">
      <table class="w-full table-auto">
        <thead>
          <tr class="bg-white/5 text-left border-b border-white/10">
            <th class="px-4 py-4 font-medium text-slate-200">Case</th>
            <th class="px-4 py-4 font-medium text-slate-200"><%= t("dashboard.status", default: "Status") %></th>
            <th class="px-4 py-4 font-medium text-slate-200">Courier</th>
            <th class="px-4 py-4 font-medium text-slate-200">Created</th>
            <th class="px-4 py-4 text-right font-medium text-slate-200">Actions</th>
          </tr>
        </thead>
        <tbody>
          <% Array(@delivery_samples).each do |delivery| %>
            <tr class="border-b border-white/10 hover:bg-white/5 transition-colors">
              <td class="px-4 py-4 text-sm font-medium text-white">
                <%= link_to "Case #{delivery.case_number}", delivery_path(delivery), class: "text-yellow-300 hover:text-yellow-200" %>
              </td>
              <td class="px-4 py-4">
                <%= render "shared/status_badge", status: delivery.status %>
              </td>
              <td class="px-4 py-4 text-sm text-slate-300"><%= delivery.courier&.full_name || "-" %></td>
              <td class="px-4 py-4 text-sm text-slate-300"><%= l(delivery.created_at, format: :short) %></td>
              <td class="px-4 py-4 text-right">
                <%= link_to "View", delivery_path(delivery), class: "inline-flex items-center rounded-xl border border-white/10 bg-white/5 px-3 py-1 text-sm font-medium text-white hover:bg-white/10" %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
<% end %>

<% if @dashboard_view == "carrier" %>
  <div class="mt-6 <%= card_class %> px-5 pt-6 pb-2.5 sm:px-7.5">
    <div class="mb-6 flex items-center justify-between">
      <h3 class="text-title-md font-semibold text-white"><%= t("dashboard.recent_payouts", default: "Payouts") %></h3>
      <%= link_to "View all", control_panel_carriers_payouts_path, class: "text-sm font-medium text-yellow-300 hover:text-yellow-200 transition-colors" %>
    </div>

    <div class="max-w-full overflow-x-auto">
      <table class="w-full table-auto">
        <thead>
          <tr class="bg-white/5 text-left border-b border-white/10">
            <th class="px-4 py-4 font-medium text-slate-200">ID</th>
            <th class="px-4 py-4 font-medium text-slate-200"><%= t("dashboard.status", default: "Status") %></th>
            <th class="px-4 py-4 font-medium text-slate-200">Amount</th>
            <th class="px-4 py-4 font-medium text-slate-200">Created</th>
          </tr>
        </thead>
        <tbody>
          <% Array(@recent_payouts).each do |payout| %>
            <tr class="border-b border-white/10 hover:bg-white/5 transition-colors">
              <td class="px-4 py-4 text-sm font-medium text-white">#<%= payout.id %></td>
              <td class="px-4 py-4 text-sm text-slate-300"><%= payout.status %></td>
              <td class="px-4 py-4 text-sm text-slate-300"><%= format_money_cents(payout.amount_cents, currency: payout.currency.presence || @currency_code, precision: 0) %></td>
              <td class="px-4 py-4 text-sm text-slate-300"><%= l(payout.created_at, format: :short) %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
<% end %>
</div>
