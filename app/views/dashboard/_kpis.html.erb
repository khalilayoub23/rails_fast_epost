<%
  # Handle both direct rendering and rendering with locals
  # Use local_assigns first, then instance variables, then fallback to 0
  card1_value = local_assigns[:card1_value] || @payments_count || 0
  card1_label = local_assigns[:card1_label] || t('dashboard.total_payments', default: 'Total Payments')
  card2_value = local_assigns[:card2_value] || (@pending_payments.respond_to?(:size) ? @pending_payments.size : (@pending_payments || 0))
  card2_label = local_assigns[:card2_label] || t('dashboard.pending_orders', default: 'Pending Orders')
  card3_value = local_assigns[:card3_value] || @customers_count || 0
  card3_label = local_assigns[:card3_label] || t('dashboard.total_customers', default: 'Total Customers')

  is_backoffice_view = %w[admin manager operational carrier].include?(@dashboard_view)
  card4_value = local_assigns[:card4_value] || (is_backoffice_view ? @revenue_total_cents : @total_spend_cents) || 0
  card4_label = local_assigns[:card4_label] || (is_backoffice_view ? t('dashboard.total_revenue', default: 'Total Revenue') : t('dashboard.total_spend', default: 'Total Spend'))
  card4_currency = local_assigns.fetch(:card4_currency, true)
  text_align = rtl? ? 'text-right' : 'text-left'
%>

<div class="grid grid-cols-1 gap-4 md:grid-cols-2 md:gap-6 xl:grid-cols-4 2xl:gap-7.5" id="dashboard_kpis">
  <% cards = [
    { value: card1_value, label: card1_label, icon: 'space_dashboard', trend: '+11.0%', trend_class: 'text-emerald-400' },
    { value: card2_value, label: card2_label, icon: 'pending_actions', trend: '-9.0%', trend_class: 'text-rose-400' },
    { value: card3_value, label: card3_label, icon: 'groups', trend: '+0.9%', trend_class: 'text-emerald-400' },
    { value: card4_value, label: card4_label, icon: 'payments', trend: '+4.3%', trend_class: 'text-emerald-400', currency: card4_currency }
  ] %>

  <% cards.each do |card| %>
    <div class="group rounded-2xl border border-white/10 bg-slate-900/70 px-6 py-5 shadow-lg shadow-black/30 backdrop-blur transition-all duration-300 hover:-translate-y-0.5 hover:border-amber-300/60 min-w-0" role="status">
      <div class="flex items-center gap-3 <%= rtl? ? 'flex-row-reverse text-right' : '' %>">
        <div class="flex h-11 w-11 items-center justify-center rounded-xl bg-amber-400/20 text-amber-300">
          <span class="material-icons text-xl"><%= card[:icon] %></span>
        </div>
        <span class="text-xs font-semibold text-slate-400"><%= card[:label] %></span>
      </div>

      <div class="mt-4 flex items-end justify-between gap-3 <%= rtl? ? 'flex-row-reverse' : '' %>">
        <div class="<%= text_align %>">
          <h4 class="text-xl font-bold text-white">
            <% if card[:currency] %>
              <%= format_money_cents(card[:value] || 0, currency: @currency_code, precision: 0) %>
            <% else %>
              <%= number_with_delimiter(card[:value].to_i) %>
            <% end %>
          </h4>
        </div>
      </div>
    </div>
  <% end %>
</div>
