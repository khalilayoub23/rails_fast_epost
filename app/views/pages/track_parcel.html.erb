<!-- Track Parcel Page -->
<section class="min-h-screen bg-gradient-to-br from-gray-900 via-gray-800 to-black text-white py-20">
  <div class="container mx-auto px-4 py-16">
    <div class="max-w-3xl mx-auto">
      <!-- Header -->
      <div class="text-center mb-12">
        <div class="flex justify-center mb-6">
          <%= search_icon(size: '64', css_class: 'animate-bounce') %>
        </div>
        <h1 class="text-4xl md:text-5xl font-bold mb-4">
          <%= t("track.title") %>
        </h1>
        <p class="text-xl text-gray-300">
          <%= t("track.subtitle") %>
        </p>
      </div>

      <!-- Tracking Form -->
      <div class="bg-gray-800 rounded-2xl p-8 border border-gray-700 mb-8">
        <%= form_with url: pages_track_parcel_path, method: :get, local: true, class: "space-y-6" do |f| %>
          <div>
            <%= f.label :tracking_number, t("track.tracking_number"), class: "block text-sm font-medium mb-2" %>
            <div class="flex gap-4">
              <%= f.text_field :tracking_number, 
                  value: params[:tracking_number],
                  class: "flex-1 px-4 py-4 bg-gray-900 border border-gray-700 rounded-lg focus:ring-2 focus:ring-yellow-400 focus:border-transparent text-white text-lg", 
                  placeholder: t("track.placeholder"),
                  required: true %>
              <%= f.submit t("track.track_button"), class: "px-8 py-4 bg-yellow-400 text-black font-bold rounded-lg hover:bg-yellow-500 transition-all transform hover:scale-105 shadow-lg cursor-pointer" %>
            </div>
          </div>
        <% end %>

        <div class="mt-6 p-4 bg-gray-900 rounded-lg">
          <p class="text-sm text-gray-400">
            <svg class="w-5 h-5 inline mr-2 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <strong><%= t("track.tip") %></strong> <%= t("track.tip_text") %>
          </p>
        </div>
      </div>

      <% if params[:tracking_number].present? %>
        <% if @task %>
          <!-- Tracking Results -->
          <div class="bg-gray-800 rounded-2xl p-8 border border-gray-700">
            <div class="mb-6">
              <h2 class="text-2xl font-bold text-yellow-400 mb-2"><%= t("track.tracking_details") %></h2>
              <p class="text-gray-300"><%= t("track.tracking_number_label") %> <strong class="text-white"><%= @task.barcode %></strong></p>
              <div class="mt-4 grid grid-cols-2 gap-4">
                <div>
                  <p class="text-sm text-gray-400">Package Type</p>
                  <p class="text-white font-semibold"><%= @task.package_type.titleize %></p>
                </div>
                <div>
                  <p class="text-sm text-gray-400">Status</p>
                  <p class="text-white font-semibold">
                    <span class="px-3 py-1 rounded-full text-sm 
                      <%= case @task.status
                          when 'delivered' then 'bg-green-600'
                          when 'in_transit' then 'bg-blue-600'
                          when 'pending' then 'bg-yellow-600'
                          when 'failed' then 'bg-red-600'
                          else 'bg-gray-600'
                          end %>">
                      <%= @task.status.humanize %>
                    </span>
                  </p>
                </div>
                <div>
                  <p class="text-sm text-gray-400">From</p>
                  <p class="text-white"><%= @task.start %></p>
                </div>
                <div>
                  <p class="text-sm text-gray-400">To</p>
                  <p class="text-white"><%= @task.target %></p>
                </div>
                <div>
                  <p class="text-sm text-gray-400">Expected Delivery</p>
                  <p class="text-white"><%= @task.delivery_time.strftime("%b %d, %Y") %></p>
                </div>
                <div>
                  <p class="text-sm text-gray-400">Carrier</p>
                  <p class="text-white"><%= @task.carrier.name if @task.carrier %></p>
                </div>
              </div>
            </div>

            <!-- Dynamic Timeline -->
            <%
              # Define status timeline stages based on actual Task enum
              timeline_stages = [
                { status: 'pending', label: 'Order Created', desc: 'Your shipment has been registered in our system', icon: 'package' },
                { status: 'in_transit', label: 'In Transit', desc: 'Package is on its way to the destination', icon: 'plane' },
                { status: 'delivered', label: 'Delivered', desc: 'Package has been successfully delivered', icon: 'check' }
              ]
              
              # Determine current stage index based on actual status
              status_order = ['pending', 'in_transit', 'delivered']
              current_index = status_order.index(@task.status) || 0
              
              # Handle special cases (failed, returned)
              if @task.status == 'failed'
                timeline_stages << { status: 'failed', label: 'Delivery Failed', desc: 'Delivery attempt was unsuccessful', icon: 'warning' }
                current_index = timeline_stages.length - 1
              elsif @task.status == 'returned'
                timeline_stages << { status: 'returned', label: 'Returned to Sender', desc: 'Package is being returned to origin', icon: 'return' }
                current_index = timeline_stages.length - 1
              end
            %>

            <div class="space-y-6">
              <% timeline_stages.each_with_index do |stage, index| %>
                <%
                  is_completed = index < current_index
                  is_current = index == current_index
                  is_future = index > current_index
                  is_last = index == timeline_stages.length - 1
                %>
                
                <div class="flex gap-4">
                  <div class="flex flex-col items-center">
                    <div class="w-12 h-12 rounded-full flex items-center justify-center <%= is_completed ? 'bg-green-500/20 ring-2 ring-green-500' : is_current ? 'bg-yellow-400/20 ring-2 ring-yellow-400 animate-pulse' : 'bg-gray-700/20 ring-2 ring-gray-700' %>">
                      <% if is_completed %>
                        <%= checkmark_icon(size: '32', css_class: 'filter brightness-125') %>
                      <% elsif is_current %>
                        <% case stage[:icon] %>
                        <% when 'package' %>
                          <%= package_icon(size: '32', css_class: 'filter brightness-125') %>
                        <% when 'plane' %>
                          <%= plane_icon(size: '32', css_class: 'filter brightness-125') %>
                        <% when 'delivery' %>
                          <%= delivery_icon(size: '32', css_class: 'filter brightness-125') %>
                        <% when 'check' %>
                          <%= checkmark_icon(size: '32', css_class: 'filter brightness-125') %>
                        <% when 'warning' %>
                          <%= warning_icon(size: '32', css_class: 'filter brightness-125') %>
                        <% when 'return' %>
                          <%= return_icon(size: '32', css_class: 'filter brightness-125') %>
                        <% else %>
                          <%= truck_icon(size: '32', css_class: 'filter brightness-125') %>
                        <% end %>
                      <% else %>
                        <% case stage[:icon] %>
                        <% when 'package' %>
                          <%= package_icon(size: '28', css_class: 'opacity-30') %>
                        <% when 'plane' %>
                          <%= plane_icon(size: '28', css_class: 'opacity-30') %>
                        <% when 'delivery' %>
                          <%= delivery_icon(size: '28', css_class: 'opacity-30') %>
                        <% when 'check' %>
                          <%= checkmark_icon(size: '28', css_class: 'opacity-30') %>
                        <% else %>
                          <%= truck_icon(size: '28', css_class: 'opacity-30') %>
                        <% end %>
                      <% end %>
                    </div>
                    <% unless is_last %>
                      <div class="w-0.5 h-16 <%= is_completed ? 'bg-green-500' : 'bg-gray-700' %> mt-2"></div>
                    <% end %>
                  </div>
                  <div class="flex-1 pb-6">
                    <p class="font-semibold text-lg <%= is_completed ? 'text-green-400' : is_current ? 'text-yellow-400' : 'text-gray-500' %>">
                      <%= stage[:label] %>
                      <% if is_current %>
                        <span class="ml-2 text-xs bg-yellow-400 text-black px-2 py-1 rounded-full">Current</span>
                      <% end %>
                    </p>
                    <p class="text-sm <%= is_future ? 'text-gray-600' : 'text-gray-400' %> mt-1">
                      <%= stage[:desc] %>
                    </p>
                    <% if is_completed %>
                      <p class="text-xs text-gray-500 mt-2">
                        <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <%= time_ago_in_words(@task.updated_at) %> ago
                      </p>
                    <% elsif is_current %>
                      <p class="text-xs text-yellow-400 mt-2 font-semibold">
                        <svg class="w-4 h-4 inline mr-1 animate-pulse" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
                        </svg>
                        Updated <%= time_ago_in_words(@task.updated_at) %> ago
                      </p>
                    <% end %>
                  </div>
                </div>
              <% end %>
            </div>

          <!-- Shipment Details Card -->
          <div class="mt-8 grid md:grid-cols-2 gap-6">
            <div class="bg-gray-900 rounded-lg p-6 border border-gray-800 hover:border-yellow-400/30 transition-colors">
              <h3 class="text-lg font-semibold mb-4 flex items-center text-yellow-400">
                <%= location_icon(size: '24', css_class: 'mr-2') %>
                Origin
              </h3>
              <p class="text-white font-medium"><%= @task.start %></p>
              <% if @task.pickup_address.present? %>
                <p class="text-sm text-gray-400 mt-2">
                  <%= [@task.pickup_address['street'], @task.pickup_address['city'], @task.pickup_address['postal_code']].compact.join(', ') %>
                </p>
              <% end %>
            </div>

            <div class="bg-gray-900 rounded-lg p-6 border border-gray-800 hover:border-yellow-400/30 transition-colors">
              <h3 class="text-lg font-semibold mb-4 flex items-center text-yellow-400">
                <%= location_icon(size: '24', css_class: 'mr-2 transform rotate-180') %>
                Destination
              </h3>
              <p class="text-white font-medium"><%= @task.target %></p>
            </div>
          </div>

          <!-- Estimated Delivery -->
          <div class="mt-6 p-6 bg-gradient-to-r from-yellow-400/20 to-yellow-600/20 rounded-lg border border-yellow-400/30 hover:border-yellow-400/50 transition-colors">
            <div class="flex items-center gap-3">
              <%= clock_icon(size: '40', css_class: '') %>
              <div>
                <p class="text-sm text-gray-400">Estimated Delivery</p>
                <p class="text-xl font-bold text-white">
                  <%= @task.delivery_time.strftime("%A, %B %d, %Y") %>
                  <span class="text-sm text-gray-400">by <%= @task.delivery_time.strftime("%I:%M %p") %></span>
                </p>
              </div>
            </div>
          </div>

          <!-- Additional Info -->
          <% if @task.carrier %>
            <div class="mt-6 p-4 bg-gray-900 rounded-lg flex items-center gap-3 border border-gray-800 hover:border-yellow-400/30 transition-colors">
              <%= delivery_icon(size: '32', css_class: '') %>
              <div>
                <p class="text-xs text-gray-400">Carrier</p>
                <p class="text-white font-semibold"><%= @task.carrier.name %></p>
                <% if @task.carrier.email.present? %>
                  <a href="mailto:<%= @task.carrier.email %>" class="text-yellow-400 hover:text-yellow-500 text-sm">
                    <%= @task.carrier.email %>
                  </a>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      <% elsif params[:tracking_number].present? %>
        </div>
            </div>
          </div>
        <% else %>
          <!-- Tracking Number Not Found -->
          <div class="bg-gray-800 rounded-2xl p-8 border border-red-700">
          <div class="flex items-start gap-4">
            <svg class="w-12 h-12 text-red-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
            </svg>
            <div class="flex-1">
              <h3 class="text-xl font-bold text-red-400 mb-2">Tracking Number Not Found</h3>
              <p class="text-gray-300">
                We couldn't find a package with tracking number <strong class="text-white"><%= params[:tracking_number] %></strong>.
              </p>
              <p class="text-gray-400 mt-2 text-sm">
                Please check the number and try again, or contact us for assistance.
              </p>
            </div>
          </div>
        <% end %>
      <% else %>
        <!-- No Tracking Number -->
        <div class="bg-gray-800 rounded-2xl p-8 border border-gray-700 text-center">
          <svg class="w-16 h-16 text-gray-600 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/>
          </svg>
          <p class="text-gray-400"><%= t("track.no_tracking") %></p>
        </div>
      <% end %>

      <!-- Help Section -->
      <div class="mt-8 grid md:grid-cols-2 gap-4">
        <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
          <h3 class="font-bold text-lg mb-2 text-yellow-400"><%= t("track.need_help") %></h3>
          <p class="text-sm text-gray-300 mb-4"><%= t("track.need_help_desc") %></p>
          <%= link_to t("track.contact_support"), pages_contact_path, class: "inline-flex items-center text-yellow-400 hover:text-yellow-500 font-medium" %>
        </div>

        <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
          <h3 class="font-bold text-lg mb-2 text-yellow-400"><%= t("track.create_shipment") %></h3>
          <p class="text-sm text-gray-300 mb-4"><%= t("track.create_shipment_desc") %></p>
          <% if user_signed_in? %>
            <%= link_to t("track.go_to_dashboard"), dashboard_path, class: "inline-flex items-center text-yellow-400 hover:text-yellow-500 font-medium" %>
          <% else %>
            <%= link_to t("track.sign_up_now"), new_user_registration_path, class: "inline-flex items-center text-yellow-400 hover:text-yellow-500 font-medium" %>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</section>
