<% senders = local_assigns.fetch(:senders) { @senders || Sender.order(:name) } %>
<% messengers = local_assigns.fetch(:messengers) { @messengers || Messenger.available.order(:name) } %>
<% carriers = local_assigns.fetch(:carriers) { @carriers || Carrier.order(:name) } %>
<% customers_collection = local_assigns.fetch(:customers) { @customer ? [@customer] : Customer.order(:name) } %>
<% task_customer = @customer || task.customer %>
<% customer_context = task_customer if task_customer&.persisted? %>
<% payment_details = local_assigns.fetch(:payment_details) { @payment_details || { "currency" => "USD" } } %>
<% form_model = task.new_record? && customer_context ? [customer_context, task] : task %>

<%= form_with model: form_model, data: { turbo_frame: "_top" }, class: "space-y-6" do |f| %>
  <% unless task_customer %>
    <div>
      <%= f.label :customer_id, t("tasks.customer"), class: "mb-2 block text-sm font-medium text-gray-200" %>
      <%= f.collection_select :customer_id, customers_collection, :id, :name,
            { prompt: t("tasks.select_customer", default: "Select customer") },
            class: "w-full rounded-lg border border-gray-600 bg-gray-900 py-3 px-4 text-white focus:border-yellow-400 focus:ring-yellow-400" %>
    </div>
  <% else %>
    <div class="rounded-lg border border-gray-700 bg-gray-900 px-4 py-3 text-sm text-gray-200">
      <strong class="text-gray-100"><%= t("tasks.customer", default: "Customer") %>:</strong>
      <%= task_customer.name %>
    </div>
    <%= f.hidden_field :customer_id, value: task_customer.id %>
  <% end %>

  <div class="grid gap-6 md:grid-cols-2">
    <% if current_user&.manager? %>
      <div>
        <%= f.label :carrier_id, t("tasks.carrier", default: "Carrier"), class: "mb-2 block text-sm font-medium text-gray-200" %>
        <%= f.collection_select :carrier_id, carriers, :id, :name,
              { prompt: t("tasks.select_carrier", default: "Select carrier") },
              class: "w-full rounded-lg border border-gray-600 bg-gray-900 py-3 px-4 text-white focus:border-yellow-400 focus:ring-yellow-400" %>
      </div>
    <% else %>
      <div class="rounded-lg border border-dashed border-gray-700 bg-gray-900/50 px-4 py-3 text-sm text-gray-400">
        <strong class="text-white"><%= t("tasks.carrier", default: "Carrier") %>:</strong>
        <%= t("tasks.carrier_assignment_pending", default: "A carrier will be assigned by the operations team after payment.") %>
        <%= f.hidden_field :carrier_id, value: nil %>
      </div>
    <% end %>
    <div>
      <%= f.label :package_type, t("tasks.package_type", default: "Package Type"), class: "mb-2 block text-sm font-medium text-gray-200" %>
      <%= f.select :package_type, Task.task_types.keys.map { |type| [type.humanize, type] }, {},
            class: "w-full rounded-lg border border-gray-600 bg-gray-900 py-3 px-4 text-white focus:border-yellow-400 focus:ring-yellow-400" %>
    </div>
  </div>

  <div>
    <%= f.label :task_type, t("tasks.task_type", default: "Task Type"), class: "mb-2 block text-sm font-medium text-gray-200" %>
    <%= f.select :task_type, Task.task_types.keys.map { |type| [type.humanize, type] }, {},
          class: "w-full rounded-lg border border-gray-600 bg-gray-900 py-3 px-4 text-white focus:border-yellow-400 focus:ring-yellow-400" %>
  </div>

  <div class="grid gap-6 md:grid-cols-2">
    <div>
      <%= f.label :start, t("tasks.start", default: "Pickup location"), class: "mb-2 block text-sm font-medium text-gray-200" %>
      <%= f.text_field :start, class: "w-full rounded-lg border border-gray-600 bg-gray-900 py-3 px-4 text-white focus:border-yellow-400 focus:ring-yellow-400", placeholder: "Search or type pickup" %>
    </div>
    <div>
      <%= f.label :target, t("tasks.target", default: "Drop-off location"), class: "mb-2 block text-sm font-medium text-gray-200" %>
      <%= f.text_field :target, class: "w-full rounded-lg border border-gray-600 bg-gray-900 py-3 px-4 text-white focus:border-yellow-400 focus:ring-yellow-400", placeholder: "Search or type drop-off" %>
    </div>
  </div>

  <div class="grid gap-6 md:grid-cols-2">
    <div>
      <%= f.label :sender_id, t("tasks.sender", default: "Sender"), class: "mb-2 block text-sm font-medium text-gray-200" %>
      <%= f.collection_select :sender_id, senders, :id, :name,
            { include_blank: t("tasks.select_sender", default: "Select sender") },
            class: "w-full rounded-lg border border-gray-600 bg-gray-900 py-3 px-4 text-white focus:border-yellow-400 focus:ring-yellow-400" %>
    </div>
    <% if current_user&.admin? || current_user&.support_agent? %>
      <div>
        <%= f.label :messenger_id, t("tasks.messenger", default: "Messenger"), class: "mb-2 block text-sm font-medium text-gray-200" %>
        <%= f.collection_select :messenger_id, messengers, :id, :name,
              { include_blank: t("tasks.select_messenger", default: "Select messenger") },
              class: "w-full rounded-lg border border-gray-600 bg-gray-900 py-3 px-4 text-white focus:border-yellow-400 focus:ring-yellow-400" %>
      </div>
    <% else %>
      <div class="rounded-lg border border-dashed border-gray-700 bg-gray-900/50 px-4 py-3 text-sm text-gray-400">
        <strong class="text-white"><%= t("tasks.messenger", default: "Messenger") %>:</strong>
        <%= t("tasks.messenger_assignment_note", default: "Messenger assignments are handled by admin or customer service after review.") %>
        <%= f.hidden_field :messenger_id, value: nil %>
      </div>
    <% end %>
  </div>

  <div class="grid gap-6 md:grid-cols-2">
    <% if current_user&.carrier? %>
      <div>
        <%= f.label :status, t("tasks.status", default: "Status"), class: "mb-2 block text-sm font-medium text-gray-200" %>
        <%= f.select :status, Task.statuses.keys.map { |status| [status.humanize, status] }, {},
              class: "w-full rounded-lg border border-gray-600 bg-gray-900 py-3 px-4 text-white focus:border-yellow-400 focus:ring-yellow-400" %>
      </div>
      <div>
        <%= f.label :failure_code, t("tasks.failure_code", default: "Failure code"), class: "mb-2 block text-sm font-medium text-gray-200" %>
        <%= f.select :failure_code, Task.failure_codes.keys.map { |code| [code.humanize, code] }, {},
              class: "w-full rounded-lg border border-gray-600 bg-gray-900 py-3 px-4 text-white focus:border-yellow-400 focus:ring-yellow-400" %>
      </div>
    <% else %>
      <div class="rounded-lg border border-dashed border-gray-700 bg-gray-900/50 px-4 py-3 text-sm text-gray-400">
        <strong class="text-white"><%= t("tasks.status", default: "Status") %>:</strong>
        <%= t("tasks.status_pending_note", default: "Status remains pending until a carrier updates progress in the field.") %>
      </div>
      <div class="rounded-lg border border-dashed border-gray-700 bg-gray-900/50 px-4 py-3 text-sm text-gray-400">
        <strong class="text-white"><%= t("tasks.failure_code", default: "Failure code") %>:</strong>
        <%= t("tasks.failure_code_locked_note", default: "Failure codes are updated by the carrier after delivery attempts.") %>
      </div>
    <% end %>
  </div>

  <div>
    <%= f.label :priority, t("tasks.priority", default: "Priority"), class: "mb-2 block text-sm font-medium text-gray-200" %>
    <%= f.select :priority, Task.priorities.keys.map { |priority| [priority.titleize, priority] }, {},
          class: "w-full rounded-lg border border-gray-600 bg-gray-900 py-3 px-4 text-white focus:border-yellow-400 focus:ring-yellow-400" %>
    <p class="mt-2 text-xs text-gray-400"><%= t("tasks.priority_help", default: "Express shipments alert messengers immediately; normal stays in the standard queue.") %></p>
  </div>

  <div class="grid gap-6 md:grid-cols-2">
    <div>
      <%= f.label :delivery_time, t("tasks.delivery_time", default: "Delivery time"), class: "mb-2 block text-sm font-medium text-gray-200" %>
      <%= f.datetime_field :delivery_time, class: "w-full rounded-lg border border-gray-600 bg-gray-900 py-3 px-4 text-white focus:border-yellow-400 focus:ring-yellow-400" %>
    </div>
    <div>
      <%= f.label :filled_form_url, t("tasks.filled_form_url", default: "Filled form URL"), class: "mb-2 block text-sm font-medium text-gray-200" %>
      <%= f.url_field :filled_form_url, class: "w-full rounded-lg border border-gray-600 bg-gray-900 py-3 px-4 text-white focus:border-yellow-400 focus:ring-yellow-400" %>
    </div>
  </div>

  <div class="grid gap-6 md:grid-cols-2">
    <div>
      <%= f.label :pickup_address, t("tasks.pickup_address", default: "Pickup address"), class: "mb-2 block text-sm font-medium text-gray-200" %>
      <%= f.text_field :pickup_address, class: "w-full rounded-lg border border-gray-600 bg-gray-900 py-3 px-4 text-white focus:border-yellow-400 focus:ring-yellow-400" %>
    </div>
    <div>
      <%= f.label :pickup_contact_phone, t("tasks.pickup_contact_phone", default: "Pickup phone"), class: "mb-2 block text-sm font-medium text-gray-200" %>
      <%= f.telephone_field :pickup_contact_phone, class: "w-full rounded-lg border border-gray-600 bg-gray-900 py-3 px-4 text-white focus:border-yellow-400 focus:ring-yellow-400" %>
    </div>
  </div>

  <div>
    <%= f.label :pickup_notes, t("tasks.pickup_notes", default: "Pickup notes"), class: "mb-2 block text-sm font-medium text-gray-200" %>
    <%= f.text_area :pickup_notes, rows: 3, class: "w-full rounded-lg border border-gray-600 bg-gray-900 py-3 px-4 text-white focus:border-yellow-400 focus:ring-yellow-400" %>
  </div>

  <div>
    <%= f.label :requested_pickup_time, t("tasks.requested_pickup_time", default: "Requested pickup time"), class: "mb-2 block text-sm font-medium text-gray-200" %>
    <%= f.datetime_field :requested_pickup_time, class: "w-full rounded-lg border border-gray-600 bg-gray-900 py-3 px-4 text-white focus:border-yellow-400 focus:ring-yellow-400" %>
  </div>

  <div class="flex items-center gap-4">
    <%= f.submit t("tasks.save", default: "Save Task"),
          class: "inline-flex items-center justify-center rounded-lg bg-yellow-400 px-6 py-3 font-semibold text-black shadow-lg transition hover:bg-yellow-300" %>
    <%= link_to t("common.cancel", default: "Cancel"),
          task.persisted? ? task_path(task) : tasks_path,
          class: "inline-flex items-center justify-center rounded-lg border border-gray-600 px-6 py-3 text-sm font-semibold text-gray-200 hover:border-yellow-400 hover:text-yellow-400" %>
  </div>
<% end %>
